---
title: "Benchmarking AI's Deliberative Reasoning: Evaluating LLMs Against Human Collective Wisdom"
author: "Francesco Veri, Gustavo Umbelino"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(reticulate)
library(tidyverse)
library(scales)
library(readxl)
library(psych)
library(boot)
library(car)
library(ggpubr)
library(rstatix)
library(data.table)

OUTPUT_DIR <- "output"
CONSISTENCY_RESULTS_FILE <- "data/consistency_results.csv"

INCLUDED_MODELS_FILE <- "data/included_models.csv"
LLM_DATA_FILE <- "data/llm_data_clean.csv"
DRI_FILE <- "data/dri_data.csv"

MAX_ITERATIONS <- 5

```


# Get Models for Analysis
```{r models, warning=FALSE}

# get models info
models <- read_csv(INCLUDED_MODELS_FILE, show_col_types = FALSE)

models %>%
  select(provider, model, is_reasoner) %>% 
  arrange(provider, model) %>%
  knitr::kable(caption = "LLMs", row.names = TRUE, col.names = c("Provider", "Model", "Is Reasoner?"))

```

## Get average DRI score for each model

```{r dri}

dri_data <- read_csv(DRI_FILE, show_col_types = FALSE)

dri_data <- dri_data %>%
  filter(iteration <= MAX_ITERATIONS) %>%
  filter(model %in% models$model) %>%
  group_by(provider, model, survey, case) %>%
  summarise(
    N = n(),
    DRIPostV3_mean = mean(DRIPostV3, na.rm=TRUE),
    .groups = "drop"
  )

```

## Calculate Alpha
```{r error=FALSE, warning=FALSE, message=FALSE}

if (!file.exists(CONSISTENCY_RESULTS_FILE)) source("02_check_consistency.R")

alpha_results <- read_csv(CONSISTENCY_RESULTS_FILE, show_col_types = FALSE)

```


```{r join data}

data <- full_join(dri_data, alpha_results, by=join_by(provider, model,survey))

data <- data %>%
  filter(!is.na(DRIPostV3_mean)) %>% ## added
  filter(!model %like% "t=1")

```

# Analysis

## Alpha vs. DRI correlation
We want to plot the corelation between ALPHA and DRI across models and cases

### Normality tests

```{r}

test_var <- data$DRIPostV3_mean

ggdensity(test_var, 
          main = "Density plot of DRI",
          xlab = "DRI")

ggqqplot(test_var)

shapiro.test(test_var)

test_var <- data$alpha_policies

ggdensity(test_var, 
          main = "Density plot of Alpha (Policies)",
          xlab = "DRI")

ggqqplot(test_var)

shapiro.test(test_var)


```

We use Spearman correlation because both variables are not normally distributed.


```{r}

data %>%
ggscatter(x = "DRIPostV3_mean", y = "alpha_policies", 
          add = "reg.line", conf.int = TRUE, 
          #facet.by = "provider",
          cor.coef = TRUE, cor.method = "spearman",
          xlab = "DRI", ylab = "Cronbach's Alpha (Policies)")




```

### Group data by Model

We grouped data by model. 
```{r}

grouped_data <- data %>%
  group_by(provider, model) %>%
  summarize(
    DRI = mean(DRIPostV3_mean, na.rm = TRUE),
    alpha = mean(alpha_policies, na.rm = TRUE)
  )

```

We tested normality again.

```{r}

test_var <- grouped_data$DRI

ggdensity(test_var, 
          main = "Density plot of DRI",
          xlab = "DRI")

ggqqplot(test_var)

shapiro.test(test_var)

test_var <- grouped_data$alpha

ggdensity(test_var, 
          main = "Density plot of Alpha (Policies)",
          xlab = "DRI")

ggqqplot(test_var)

shapiro.test(test_var)

```
And used Spearman correlation.

```{r}

labels <- grouped_data[which(grouped_data$alpha > 0.80 | grouped_data$DRI > 0.35), ]$model

nrow(grouped_data)

grouped_data %>%
  ggscatter(
    x = "DRI",
    y = "alpha",
    add = "reg.line",
    # ylim=c(0.7, 0.9),
    #xlim=c(-0.1, 0.5),
    #label = "model",
    #repel = TRUE,
    #label.select = labels,
    # label.rectangle = TRUE,
    conf.int = TRUE,
    cor.coef = TRUE,
    cor.method = "spearman",
    #title = "Spearman Correlation Grouped by Model",
    xlab = "LLM DRI (post-deliberation, individual-level)",
    ylab = "Cronbach's alpha (policies)"
  ) -> plot

plot

ggsave(
  paste(OUTPUT_DIR, "plots", "book1.png", sep = "/"),
  plot,
  width = 8,
  height = 4
)

cor.test(grouped_data$DRI, grouped_data$alpha, method = "spearman")


```


## Alpha vs. Reasoning 

```{r}
data <- full_join(data, models, by=join_by(provider,model))

# data <- data %>%
#   filter(!is.na(survey))

```

```{r}

grouped_data <- data %>%
  group_by(provider, model, is_reasoner) %>%
  summarize(
    DRI = mean(DRIPostV3_mean, na.rm = TRUE),
    alpha = mean(alpha_policies, na.rm = TRUE)
  )

grouped_data <- grouped_data %>%
  mutate(is_reasoner_clean = ifelse(is.na(is_reasoner), FALSE, is_reasoner))

grouped_data %>%
  ggboxplot(x = "is_reasoner_clean", y = "alpha", add = "jitter")  

labels <- grouped_data[which(grouped_data$alpha > 0.83), ]$model

grouped_data %>%
  group_by(is_reasoner_clean) %>%
  get_summary_stats(alpha, type = "median_iqr")

res.wilcox <- grouped_data %>%
  as.data.frame() %>%
  wilcox_test(alpha ~ is_reasoner_clean, detailed = TRUE) %>%
  add_significance() %>%
  add_xy_position(x = "is_reasoner_clean")
res.wilcox

grouped_data %>%
  as.data.frame() %>%
  wilcox_effsize(alpha ~ is_reasoner_clean)


n_reasoners <- grouped_data %>% filter(is_reasoner_clean) %>% nrow()
n_non_reasoners <- grouped_data %>% filter(!is_reasoner_clean) %>% nrow()

grouped_data %>%
  ggboxplot(
    x = "is_reasoner_clean",
    y = "alpha",
    color = "is_reasoner_clean",
    add = c("jitter"),
    label = "model",
    repel = TRUE,
    label.select = labels,
  ) +
  # ggboxplot(x = "source_type", y = "DRIPostV3", color="source_type") +
  #rotate_x_text(70) +
  stat_pvalue_manual(res.wilcox, tip.length = 0) +
  labs(
    # title = "Human vs. LLM Post-Deliberation DRI",
    caption = get_test_label(res.wilcox, detailed = TRUE),
    #caption = get_pwc_label(pwc),
  ) +
  xlab("Reasoning capability") +
  ylab("Cronbach's alpha (policies)") +
  stat_summary(
    fun.data = function(x)
      data.frame(y = 0.88, label = paste0("\U00B5 = ", round(mean(
        x
      ), 2))),
    geom = "text"
  ) +
  scale_x_discrete(labels = c("TRUE" = paste0("Reasoner (N = ", n_reasoners, ")"), "FALSE" = paste0("Non-Reasoner (N = ", n_non_reasoners, ")"))) +
  theme(legend.position = "none") -> plot

plot

ggsave(
  paste(OUTPUT_DIR, "plots", "book2.png", sep = "/"),
  plot,
  width = 8,
  height = 4
)

```


```{r}

res.wilcox <- grouped_data %>%
  as.data.frame() %>%
  wilcox_test(DRI ~ is_reasoner_clean, detailed = TRUE) %>%
  add_significance() %>%
  add_xy_position(x = "is_reasoner_clean")
res.wilcox

grouped_data %>%
  group_by(is_reasoner_clean) %>%
  get_summary_stats(DRI, type = "median_iqr")

grouped_data %>%
  as.data.frame() %>%
  wilcox_effsize(DRI ~ is_reasoner_clean)

grouped_data %>%
  ggboxplot(
    x = "is_reasoner_clean",
    y = "DRI",
    color = "is_reasoner_clean",
    add = c("jitter")
  ) +
  # ggboxplot(x = "source_type", y = "DRIPostV3", color="source_type") +
  #rotate_x_text(70) +
  labs(
    # title = "Human vs. LLM Post-Deliberation DRI",
    caption = get_test_label(res.wilcox, detailed = TRUE),
    #caption = get_pwc_label(pwc),
  ) +
  xlab("Reasoning capability") +
  ylab("LLM DRI") +
  stat_summary(
    fun.data = function(x)
      data.frame(y = 0.5, label = paste0("\U00B5 = ", round(mean(
        x
      ), 2))),
    geom = "text"
  ) +
  scale_x_discrete(labels = c("TRUE" = paste0("Reasoner (N = ", n_reasoners, ")"), "FALSE" = paste0("Non-Reasoner (N = ", n_non_reasoners, ")"))) +
  theme(legend.position = "none") -> plot

plot

ggsave(
  paste(OUTPUT_DIR, "plots", "book3.png", sep = "/"),
  plot,
  width = 8,
  height = 4
)

```

```{r, fig.width=8,fig.height=4}

selected_data <- grouped_data %>%
  filter(model %like% "grok-3-mini" |
           model %like% "claude-3-7-sonnet-20250219") %>%
  mutate(family = case_when(
    model %like% "grok-3-mini-beta" ~ "grok-3-mini",
    model %like% "grok-3-mini-fast" ~ "grok-3-mini-fast",
    model %like% "claude-3-7-sonnet" ~ "claude-3-7-sonnet",
    .default = NA
  )) %>%
  mutate(label = case_when(
    model %like% "low" ~ "effort = low",
    model %like% "high" ~ "effort = high",
    .default = family
  ))


selected_data %>%
  ggdotplot(
    x="is_reasoner_clean",
    y="DRI",
    label = "label",
    #label.rectangle = TRUE,
    facet.by = "family",
    fill = "is_reasoner_clean",
    color = "is_reasoner_clean",
    ylim = c(0.11,0.41),
    title = "DRI vs. Reasoning Capability"
  ) +
  xlab("Reasoning Capability") +
  ylab("DRI") +
  scale_x_discrete(labels = c("TRUE" = "Reasoner", "FALSE" = "Non-Reasoner")) +
  theme(legend.position = "none") -> plot

plot

ggsave(
  paste(OUTPUT_DIR, "plots", "book4.png", sep = "/"),
  plot,
  width = 8,
  height = 4
)



```

```{r}

nrow(models)

length(unique(data$survey))

length(unique(data$case))

length(unique(data$model))

llm_data <- read_csv(LLM_DATA_FILE, show_col_types = FALSE)

nrow(llm_data)

nrow(data) * 5

summary(data$alpha_considerations)
summary(data$alpha_policies)

data %>%
  select(alpha_considerations, alpha_policies) %>%
  get_summary_stats(type = "common")

data %>%
  filter(alpha_considerations <= 0 | alpha_policies <= 0) %>%
    select(model, survey, alpha_considerations, alpha_policies)

data %>%
  filter(alpha_considerations >= 1 | alpha_policies >= 1) %>%
  select(model, survey, alpha_considerations, alpha_policies)

```


